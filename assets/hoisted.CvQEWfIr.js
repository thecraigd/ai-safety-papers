const y="https://api.theguardrail.net";async function d(e,t={}){const n=await fetch(`${y}${e}`,{...t,credentials:"include",headers:{"Content-Type":"application/json",...t.headers}});if(!n.ok){const s=await n.json().catch(()=>({error:"Request failed"}));throw new Error(s.error||"Request failed")}return n.json()}async function P(){return d("/auth/me")}async function N(){await d("/auth/logout",{method:"POST"})}function R(e,t){const n=t?`?returnTo=${encodeURIComponent(t)}`:"";return`${y}/auth/${e}${n}`}async function X(){return(await d("/bookmarks")).paper_ids}async function Z(e){await d("/bookmarks",{method:"POST",body:JSON.stringify({paper_id:e})})}async function q(e){return(await d("/bookmarks",{method:"POST",body:JSON.stringify({paper_ids:e})})).imported}async function ee(e){await d(`/bookmarks/${encodeURIComponent(e)}`,{method:"DELETE"})}function te(){return`${y}/account/export`}async function ne(){await d("/account",{method:"DELETE"})}const A="guardrail_bookmarks",T="authStateChanged";let a={isLoading:!0,isAuthenticated:!1,user:null};async function j(){try{const e=await P();a={isLoading:!1,isAuthenticated:e.authenticated,user:e.user||null},a.isAuthenticated&&await F()}catch(e){console.error("Failed to check auth status:",e),a={isLoading:!1,isAuthenticated:!1,user:null}}return M(),a}function se(){return a}async function J(){try{await N()}catch(e){console.error("Logout error:",e)}a={isLoading:!1,isAuthenticated:!1,user:null},M()}function K(e,t){const n=window.location.pathname+window.location.search;window.location.href=R(e,n)}function M(){window.dispatchEvent(new CustomEvent(T,{detail:a}))}async function F(){try{const e=localStorage.getItem(A);if(!e)return;const t=JSON.parse(e);if(!Array.isArray(t)||t.length===0)return;const n=await q(t);localStorage.removeItem(A),n>0&&G(`Imported ${n} paper${n===1?"":"s"} from this device`)}catch(e){console.error("Failed to migrate localStorage bookmarks:",e)}}function G(e){const t=document.createElement("div");t.className="fixed bottom-4 right-4 bg-brass-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.classList.add("animate-fade-out"),setTimeout(()=>t.remove(),300)},3e3)}const i=document.getElementById("mobile-menu-toggle"),l=document.getElementById("mobile-menu"),L=document.getElementById("menu-icon-open"),E=document.getElementById("menu-icon-close");i?.addEventListener("click",()=>{const e=i.getAttribute("aria-expanded")==="true";i.setAttribute("aria-expanded",(!e).toString()),l?.classList.toggle("hidden"),L?.classList.toggle("hidden"),E?.classList.toggle("hidden")});document.addEventListener("click",e=>{const t=e.target;!t.closest("#mobile-menu")&&!t.closest("#mobile-menu-toggle")&&(l?.classList.add("hidden"),i?.setAttribute("aria-expanded","false"),L?.classList.remove("hidden"),E?.classList.add("hidden"))});l?.querySelectorAll("a").forEach(e=>{e.addEventListener("click",()=>{l?.classList.add("hidden"),i?.setAttribute("aria-expanded","false"),L?.classList.remove("hidden"),E?.classList.add("hidden")})});document.addEventListener("keydown",e=>{e.key==="Escape"&&(b?.classList.add("hidden"),c?.setAttribute("aria-expanded","false"))});const H=document.getElementById("theme-toggle-desktop"),z=document.getElementById("theme-toggle-mobile"),U=()=>{const e=document.documentElement.classList.toggle("dark");localStorage.setItem("theme",e?"dark":"light")};H?.addEventListener("click",U);z?.addEventListener("click",U);const h=document.getElementById("sign-in-btn-desktop"),v=document.getElementById("user-menu-desktop"),c=document.getElementById("user-menu-toggle-desktop"),b=document.getElementById("user-menu-dropdown-desktop"),u=document.getElementById("user-avatar-desktop"),I=document.getElementById("user-name-desktop"),B=document.getElementById("user-email-desktop"),Y=document.getElementById("sign-out-btn-desktop"),p=document.getElementById("sign-in-btn-mobile"),o=document.getElementById("user-avatar-mobile"),x=document.getElementById("mobile-user-info"),C=document.getElementById("mobile-user-name"),S=document.getElementById("mobile-user-email"),m=document.getElementById("mobile-my-papers-link"),g=document.getElementById("mobile-account-link"),r=document.getElementById("sign-out-btn-mobile");c?.addEventListener("click",e=>{e.stopPropagation();const t=c.getAttribute("aria-expanded")==="true";c.setAttribute("aria-expanded",(!t).toString()),b?.classList.toggle("hidden")});document.addEventListener("click",e=>{const t=e.target;!t.closest("#user-menu-dropdown-desktop")&&!t.closest("#user-menu-toggle-desktop")&&(b?.classList.add("hidden"),c?.setAttribute("aria-expanded","false"))});h?.addEventListener("click",()=>{window.dispatchEvent(new CustomEvent("openAuthModal"))});p?.addEventListener("click",()=>{window.dispatchEvent(new CustomEvent("openAuthModal"))});o?.addEventListener("click",()=>{l?.classList.remove("hidden"),i?.setAttribute("aria-expanded","true"),L?.classList.add("hidden"),E?.classList.remove("hidden")});async function _(){await J(),window.location.reload()}Y?.addEventListener("click",_);r?.addEventListener("click",_);function Q(e,t){if(e){const n=e.split(" ");return n.length>=2?(n[0][0]+n[n.length-1][0]).toUpperCase():e[0].toUpperCase()}return t[0].toUpperCase()}function D(e){if(e.isLoading){h?.classList.add("hidden"),v?.classList.add("hidden"),p?.classList.add("hidden"),o?.classList.add("hidden");return}if(e.isAuthenticated&&e.user){const t=e.user,n=Q(t.name,t.email);if(h?.classList.add("hidden"),v?.classList.remove("hidden"),u)if(t.avatar_url&&/^https:\/\//.test(t.avatar_url)){const s=document.createElement("img");s.src=t.avatar_url,s.alt="",s.className="w-7 h-7 rounded-full",u.textContent="",u.appendChild(s)}else u.textContent=n;if(I&&(I.textContent=t.name||"User"),B&&(B.textContent=t.email),p?.classList.add("hidden"),o?.classList.remove("hidden"),o?.classList.add("flex"),o)if(t.avatar_url&&/^https:\/\//.test(t.avatar_url)){const s=document.createElement("img");s.src=t.avatar_url,s.alt="",s.className="w-8 h-8 rounded-full",o.textContent="",o.appendChild(s)}else o.textContent=n;x?.classList.remove("hidden"),m?.classList.remove("hidden"),m?.classList.add("flex"),g?.classList.remove("hidden"),g?.classList.add("flex"),r?.classList.remove("hidden"),r?.classList.add("flex"),C&&(C.textContent=t.name||"User"),S&&(S.textContent=t.email)}else h?.classList.remove("hidden"),v?.classList.add("hidden"),p?.classList.remove("hidden"),o?.classList.add("hidden"),o?.classList.remove("flex"),x?.classList.add("hidden"),m?.classList.add("hidden"),m?.classList.remove("flex"),g?.classList.add("hidden"),g?.classList.remove("flex"),r?.classList.add("hidden"),r?.classList.remove("flex")}window.addEventListener(T,e=>{D(e.detail)});j().then(D);const w=document.getElementById("auth-modal"),V=document.getElementById("auth-modal-backdrop"),W=document.getElementById("auth-modal-close"),O=document.querySelectorAll(".auth-provider-btn");let f=null;function $(e){f=e||null,w?.classList.remove("hidden"),document.body.style.overflow="hidden",O[0]?.focus()}function k(){w?.classList.add("hidden"),document.body.style.overflow="",f=null}V?.addEventListener("click",k);W?.addEventListener("click",k);document.addEventListener("keydown",e=>{e.key==="Escape"&&!w?.classList.contains("hidden")&&k()});O.forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-provider");t&&(f&&sessionStorage.setItem("pendingSavePaperId",f),K(t))})});window.openAuthModal=$;window.closeAuthModal=k;window.addEventListener("openAuthModal",e=>{$(e.detail?.paperId)});export{T as A,se as a,X as b,Z as c,ne as d,te as g,j as i,J as l,ee as r,G as s};
